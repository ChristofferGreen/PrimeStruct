#!/usr/bin/env bash
set -euo pipefail

msg_file="$1"

if [[ ! -f "$msg_file" ]]; then
  echo "commit-msg: cannot read commit message file" >&2
  exit 1
fi

# Strip comments and trim trailing whitespace.
mapfile -t lines < <(sed -e 's/[[:space:]]*$//' -e '/^#/d' "$msg_file")

if [[ ${#lines[@]} -eq 0 ]]; then
  echo "commit-msg: empty commit message" >&2
  exit 1
fi

subject="${lines[0]}"

if [[ -z "$subject" ]]; then
  echo "commit-msg: subject line is empty" >&2
  exit 1
fi

if [[ ${#subject} -gt 50 ]]; then
  echo "commit-msg: subject line exceeds 50 characters" >&2
  exit 1
fi

if [[ "$subject" != [A-Z]* ]]; then
  echo "commit-msg: subject line must start with a capital letter" >&2
  exit 1
fi

if [[ "$subject" == *"." ]]; then
  echo "commit-msg: subject line must not end with a period" >&2
  exit 1
fi

# Require a blank line and a non-empty body.
if [[ ${#lines[@]} -lt 3 ]]; then
  echo "commit-msg: missing body (need blank line + body)" >&2
  exit 1
fi

if [[ -n "${lines[1]}" ]]; then
  echo "commit-msg: second line must be blank" >&2
  exit 1
fi

body_has_content=0
for ((i=2; i<${#lines[@]}; ++i)); do
  if [[ -n "${lines[i]}" ]]; then
    body_has_content=1
  fi
  if [[ ${#lines[i]} -gt 72 ]]; then
    echo "commit-msg: body line exceeds 72 characters" >&2
    exit 1
  fi
done

if [[ $body_has_content -eq 0 ]]; then
  echo "commit-msg: body must contain at least one non-empty line" >&2
  exit 1
fi

exit 0
